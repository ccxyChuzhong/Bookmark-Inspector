<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>ç®€å•æµ‹è¯•</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .btn { padding: 10px 20px; margin: 10px; background: #0078d7; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; }
    .modal-content { background: white; padding: 20px; border-radius: 8px; max-width: 400px; width: 90%; }
    .setting-group { margin: 10px 0; }
    .setting-label { display: block; margin-bottom: 5px; font-weight: bold; }
    select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    .mode-description { margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 4px; }
    .modal-footer { margin-top: 20px; text-align: right; }
    .modal-footer .btn { margin-left: 10px; }
  </style>
</head>
<body>
  <h1>ä¹¦ç­¾å¯¼å…¥åŠŸèƒ½æµ‹è¯•</h1>
  
  <button id="importBtn" class="btn">é€‰æ‹©æ–‡ä»¶å¯¼å…¥</button>
  <input type="file" id="importFile" accept=".json,.html,.csv,.md" style="display:none;">
  
  <div id="testOutput" style="margin-top: 20px; padding: 10px; border: 1px solid #ddd; min-height: 100px;">
    <p>æµ‹è¯•è¾“å‡ºå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>
  </div>

  <!-- å¯¼å…¥è®¾ç½®æ¨¡æ€å¯¹è¯æ¡† -->
  <div id="importModal" class="modal">
    <div class="modal-content">
      <h3>å¯¼å…¥ä¹¦ç­¾è®¾ç½®</h3>
      <div class="setting-group">
        <label for="importTargetFolder" class="setting-label">å¯¼å…¥åˆ°æ–‡ä»¶å¤¹ï¼š</label>
        <select id="importTargetFolder">
          <option value="1">ä¹¦ç­¾æ </option>
          <option value="test-folder">æµ‹è¯•æ–‡ä»¶å¤¹</option>
        </select>
      </div>
      <div class="setting-group">
        <label for="importMode" class="setting-label">å¯¼å…¥æ–¹å¼ï¼š</label>
        <select id="importMode">
          <option value="flatten">å¹³é“ºæ¨¡å¼ï¼ˆæ‰€æœ‰ä¹¦ç­¾å¯¼å…¥åˆ°æ ¹ç›®å½•ï¼‰</option>
          <option value="preserve">ä¿æŒç»“æ„ï¼ˆä¿æŒåŸæœ‰æ–‡ä»¶å¤¹ç»“æ„ï¼‰</option>
        </select>
      </div>
      <div class="mode-description">
        <p id="modeDescription">å¹³é“ºæ¨¡å¼ï¼šå°†JSONæ–‡ä»¶ä¸­çš„æ‰€æœ‰ä¹¦ç­¾æå–å‡ºæ¥ï¼Œå…¨éƒ¨å¯¼å…¥åˆ°é€‰ä¸­æ–‡ä»¶å¤¹çš„æ ¹ç›®å½•ä¸‹ï¼Œä¸ä¿æŒåŸæœ‰çš„æ–‡ä»¶å¤¹ç»“æ„ã€‚</p>
      </div>
      <div class="modal-footer">
        <button id="cancelImport" class="btn" style="background: #666;">å–æ¶ˆ</button>
        <button id="confirmImport" class="btn">é€‰æ‹©æ–‡ä»¶</button>
      </div>
    </div>
  </div>

  <script>
    // æ¨¡æ‹ŸChromeä¹¦ç­¾API
    window.chrome = {
      bookmarks: {
        create: function(bookmark) {
          return new Promise((resolve) => {
            console.log('åˆ›å»ºä¹¦ç­¾:', bookmark);
            const testOutput = document.getElementById('testOutput');
            const div = document.createElement('div');
            div.style.padding = '5px';
            div.style.borderBottom = '1px solid #eee';
            if (bookmark.url) {
              div.innerHTML = `ğŸ“„ ä¹¦ç­¾: ${bookmark.title} -> ${bookmark.url} (çˆ¶æ–‡ä»¶å¤¹: ${bookmark.parentId})`;
            } else {
              div.innerHTML = `ğŸ“ æ–‡ä»¶å¤¹: ${bookmark.title} (çˆ¶æ–‡ä»¶å¤¹: ${bookmark.parentId})`;
            }
            testOutput.appendChild(div);
            resolve({ id: 'mock-id-' + Date.now() });
          });
        }
      }
    };
    
    // æ˜¾ç¤ºæ¶ˆæ¯å‡½æ•°
    function showMessage(text, isError = false) {
      const testOutput = document.getElementById('testOutput');
      const div = document.createElement('div');
      div.style.padding = '10px';
      div.style.margin = '5px 0';
      div.style.borderRadius = '4px';
      div.style.backgroundColor = isError ? '#ffebee' : '#e8f5e8';
      div.style.color = isError ? '#c62828' : '#2e7d32';
      div.textContent = text;
      testOutput.appendChild(div);
    }

    // æ˜¾ç¤ºå¯¼å…¥è®¾ç½®æ¨¡æ€å¯¹è¯æ¡†
    function showImportModal() {
      const modal = document.getElementById('importModal');
      if (modal) {
        modal.style.display = 'flex';
        updateModeDescription();
      }
    }

    // éšè—å¯¼å…¥è®¾ç½®æ¨¡æ€å¯¹è¯æ¡†
    function hideImportModal() {
      const modal = document.getElementById('importModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }

    // æ›´æ–°å¯¼å…¥æ¨¡å¼æè¿°
    function updateModeDescription() {
      const importMode = document.getElementById('importMode');
      const modeDescription = document.getElementById('modeDescription');
      
      if (importMode && modeDescription) {
        const mode = importMode.value;
        if (mode === 'flatten') {
          modeDescription.textContent = 'å¹³é“ºæ¨¡å¼ï¼šå°†JSONæ–‡ä»¶ä¸­çš„æ‰€æœ‰ä¹¦ç­¾æå–å‡ºæ¥ï¼Œå…¨éƒ¨å¯¼å…¥åˆ°é€‰ä¸­æ–‡ä»¶å¤¹çš„æ ¹ç›®å½•ä¸‹ï¼Œä¸ä¿æŒåŸæœ‰çš„æ–‡ä»¶å¤¹ç»“æ„ã€‚';
        } else {
          modeDescription.textContent = 'ä¿æŒç»“æ„ï¼šå®Œå…¨ä¿æŒJSONæ–‡ä»¶ä¸­çš„åŸæœ‰æ–‡ä»¶å¤¹ç»“æ„ï¼Œåœ¨é€‰ä¸­çš„æ–‡ä»¶å¤¹ä¸‹é‡å»ºç›¸åŒçš„ç›®å½•å±‚æ¬¡ã€‚';
        }
      }
    }

    // å¹³é“ºä¹¦ç­¾æ•°ç»„
    function flattenBookmarks(bookmarks) {
      const flattened = [];
      
      function extractBookmarks(items) {
        for (const item of items) {
          if (item.url) {
            flattened.push({
              title: item.title || 'æœªå‘½å',
              url: item.url
            });
          } else if (item.children && Array.isArray(item.children)) {
            extractBookmarks(item.children);
          }
        }
      }
      
      extractBookmarks(bookmarks);
      return flattened;
    }

    // å¯¼å…¥å•ä¸ªä¹¦ç­¾é¡¹
    async function importBookmarkItem(item, parentId) {
      if (!item || typeof item !== 'object') return;
      
      const url = item.url;
      const title = item.title || 'æœªå‘½å';
      const children = item.children;
      
      if (url) {
        await chrome.bookmarks.create({
          parentId: parentId,
          title: title,
          url: url
        });
      } else if (children && Array.isArray(children)) {
        const newFolder = await chrome.bookmarks.create({
          parentId: parentId,
          title: title
        });
        
        for (const child of children) {
          await importBookmarkItem(child, newFolder.id);
        }
      } else {
        await chrome.bookmarks.create({
          parentId: parentId,
          title: title
        });
      }
    }

    // å¤„ç†å¯¼å…¥çš„ä¹¦ç­¾æ•°æ®
    async function processImport(bookmarks) {
      try {
        if (!bookmarks) {
          throw new Error('æ— æ•ˆçš„JSONæ•°æ®');
        }
        
        const importTargetFolder = document.getElementById('importTargetFolder');
        const importMode = document.getElementById('importMode');
        
        const targetFolderId = importTargetFolder ? importTargetFolder.value : '1';
        const mode = importMode ? importMode.value : 'flatten';
        
        const bookmarksArray = Array.isArray(bookmarks) ? bookmarks : [bookmarks];
        
        showMessage(`å¼€å§‹å¯¼å…¥ï¼Œæ¨¡å¼ï¼š${mode === 'flatten' ? 'å¹³é“º' : 'ä¿æŒç»“æ„'}ï¼Œç›®æ ‡æ–‡ä»¶å¤¹ï¼š${targetFolderId}`);
        
        if (mode === 'preserve') {
          for (const item of bookmarksArray) {
            await importBookmarkItem(item, targetFolderId);
          }
        } else {
          const flattenedBookmarks = flattenBookmarks(bookmarksArray);
          for (const bookmark of flattenedBookmarks) {
            if (bookmark.url) {
              await chrome.bookmarks.create({
                parentId: targetFolderId,
                title: bookmark.title || 'æœªå‘½å',
                url: bookmark.url
              });
            }
          }
        }
        
        showMessage('ä¹¦ç­¾å¯¼å…¥æˆåŠŸï¼');
      } catch (error) {
        showMessage('JSONå¯¼å…¥å¤±è´¥: ' + error.message, true);
      }
    }

    // å¯¼å…¥ä¹¦ç­¾
    function importBookmarks(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async function(e) {
        const content = e.target.result;
        const fileExtension = file.name.split('.').pop().toLowerCase();
        
        try {
          if (fileExtension === 'json') {
            const bookmarks = JSON.parse(content);
            await processImport(bookmarks);
          } else {
            showMessage("ç›®å‰åªæ”¯æŒJSONæ ¼å¼æµ‹è¯•", true);
          }
        } catch (error) {
          showMessage(`å¯¼å…¥å¤±è´¥: ${error.message}`, true);
        }
      };
      
      reader.readAsText(file);
    }

    // äº‹ä»¶ç›‘å¬å™¨
    document.addEventListener('DOMContentLoaded', function() {
      // å¯¼å…¥æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      document.getElementById('importBtn').addEventListener('click', showImportModal);
      
      // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
      document.getElementById('importFile').addEventListener('change', importBookmarks);
      
      // æ¨¡æ€å¯¹è¯æ¡†äº‹ä»¶
      document.getElementById('cancelImport').addEventListener('click', hideImportModal);
      document.getElementById('confirmImport').addEventListener('click', function() {
        hideImportModal();
        document.getElementById('importFile').click();
      });
      
      // å¯¼å…¥æ¨¡å¼å˜åŒ–äº‹ä»¶
      document.getElementById('importMode').addEventListener('change', updateModeDescription);
      
      // ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€å¯¹è¯æ¡†
      document.getElementById('importModal').addEventListener('click', function(e) {
        if (e.target === this) {
          hideImportModal();
        }
      });
    });
  </script>
</body>
</html>
